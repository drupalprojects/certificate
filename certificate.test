<?php

/**
 * @file certificate.test
 */

/**
 * Tests for Certificate.
 */
class CertificateTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    // Note that getInfo() strings are not translated with t().
    return array(
      'name' => 'Certificate',
      'description' => 'Ensure that the Certificate module functions properly.',
      'group' => 'Certificate',
    );
  }

  public function setUp() {
    parent::setUp(array('certificate', 'certificate_test'));

    // Set up an activity.
    $this->contentType = $this->drupalCreateContentType(array('type' => 'certificate_activity'));
    variable_set("certificate_certifiable_" . $this->contentType->type, TRUE);
  }

  /**
   * Test the certificate access check.
   */
  public function testCertificateAccess() {
    $u1 = $this->drupalCreateUser();

    // Create an activity.
    $activity_node = $this->drupalCreateNode(array('type' => $this->contentType->type));

    // Check for forbidden certificate.
    $result = certificate_can_access_certificate($activity_node, $u1);
    $this->assertTrue($result !== TRUE, 'User cannot access certificate.');
    $this->assertTrue($result == 'Custom access denied message.', 'Error message matched module provided message.');

    // Set certificates to appear.
    $GLOBALS['certificate_ok'] = TRUE;
    $result = certificate_can_access_certificate($activity_node, $u1, TRUE);
    $this->assertTrue($result === TRUE, 'User can access certificate.');
  }

  /**
   * Test that the user receives the correct certificate.
   */
  public function testCertificateMapping() {
    $activity_node = $this->drupalCreateNode(array('type' => $this->contentType->type));
    $content = array(
      'title' => 'Test Certificate',
      'name' => 'test_certificate',
      'orientation' => 'portrait',
      'certificate_body' => array(LANGUAGE_NONE => array(array('value' => 'My Certificate Body 1'))),
    );
    $certificate = entity_create('certificate', $content);
    entity_save('certificate', $certificate);

    // We give them the permission because we have to preview it here.
    $u1 = $this->drupalCreateUser(array('administer certificates'));
    $firstletter = $u1->name[0];

    $this->drupalLogin($u1);
    $GLOBALS['certificate_ok'] = TRUE;

    $this->drupalGet("node/{$activity_node->nid}/certificate", array('query' => array('certificate_ok' => 1, 'preview' => TRUE)));
    $this->assertNoResponse(403, 'Did not get access denied.');
    $this->assertNoText('Custom access denied message.', 'Did not find moduled provided access denied message on certificate page.');
    $this->assertText('Sorry, there is no certificate available.', 'Found no certificate available text.');

    // Map the first letter of the user's name to the certificate.
    certificate_update_node_mappings($activity_node->nid, array(
      'firstletter' => array(
        $firstletter => $certificate->cid,
      ),
    ));

    $this->drupalGet("node/{$activity_node->nid}/certificate", array('query' => array('certificate_ok' => 1, 'preview' => TRUE)));
    $this->assertNoResponse(403, 'Did not get access denied.');
    $this->assertNoText('Custom access denied message.', 'Did not find module provided access denied message on certificate page.');
    $this->assertNoText('Sorry, there is no certificate available.', 'User received certificate.');
    $this->assertText("My Certificate Body 1", "Saw certificate body.");
  }

  /**
   * Test the token replacement inside of certificates.
   */
  function testCertificateTemplates() {
    // We give them the permission because we have to preview it here.
    $account = $this->drupalCreateUser(array('administer certificates'));
    $activity_node = $this->drupalCreateNode(array(
      'title' => 'My test certifiable type',
      'type' => $this->contentType->type,
    ));

    $content = array(
      'title' => 'Test Certificate',
      'name' => 'test_certificate',
      'orientation' => 'portrait',
      'certificate_body' => array(LANGUAGE_NONE => array(array('value' => 'My Certificate Body [node:title] [user:name]'))),
    );
    $certificate = entity_create('certificate', $content);
    entity_save('certificate', $certificate);
    $firstletter = $account->name[0];

    // Map the first letter of the user's name to the certificate.
    certificate_update_node_mappings($activity_node->nid, array(
      'firstletter' => array(
        $firstletter => $certificate->cid,
      ),
    ));

    $this->drupalLogin($account);
    $this->drupalGet("node/{$activity_node->nid}/certificate", array('query' => array('certificate_ok' => 1, 'preview' => TRUE)));
    $this->assertText("My Certificate Body $activity_node->title $account->name", "Saw certificate body.");
  }

}
